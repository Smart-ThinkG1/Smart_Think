<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>

    <!-- Icone da Página -->
    <link rel="shortcut icon" href="../assets/iconPage.png" type="image/x-icon">
    <!-- Icons Font Awesome -->
    <script src="https://kit.fontawesome.com/64ceb195cd.js" crossorigin="anonymous"></script>
    <!-- Icones Box Icons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <!-- CSS do DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <!-- CSS do Swipper Slides -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- JS do DataTables -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <!-- CSS Local -->
    <link rel="stylesheet" href="../css/dashboard.css">
</head>

<body>


    <div class="dash-box">

        <!-- sidebar -->
        <div class="sidebar">

            <!-- header sidebar -->
            <div class="header-sidebar">

                <!-- logo -->
                <div class="nav-logo">
                    <img src="../assets/logoBranca.svg" alt="">
                    <h2>Smart Think</h2>
                </div>

                <!-- botão que muda sidebar -->
                <div id="toggle-dash-btn">
                    <i class="fa-solid fa-bars"></i>
                </div>
            </div>
            <!-- fim header sidebar -->

            <!-- menu sidebar -->
            <nav class="menu">
                <div class="menu-label">
                    <h2>Menu</h2>
                </div>
                <ul class="nav-menu">

                    <!-- visão geral -->
                    <li class="nav-item active">
                        <a href="dashboard.html">
                            <i class='bx bxs-grid-alt'></i>
                            <p>Relatório da Marca</p>
                        </a>
                    </li>

                    <!-- unidades -->
                    <li class="nav-item submenu">
                        <i class='bx bxs-store'></i>
                        <p>Unidades</p>
                        <span>▾</span>
                    </li>
                    <ul class="submenu-list">

                        <li class="submenu-item">
                            <a href="#">
                                <i class='bx bxs-plus-circle'></i>
                                <p>Nova Unidade</p>
                            </a>
                        </li>

                    </ul>


                    <!-- notificações -->
                    <!-- <li class="nav-item">
                        <a href="">
                            <i class='bx bxs-inbox'></i>
                            <p>Atividades</p>
                        </a>
                    </li> -->

                    <!-- configurações -->
                    <li class="nav-item submenu">
                        <i class='bx bxs-cog'></i>
                        <p>Configurações</p>
                        <span>▾</span>
                    </li>
                    <ul class="submenu-list">
                        <li class="submenu-item nav-item">
                            <a href="contents/userSettings.html">
                                <p>Gerenciar perfil</p>
                            </a>
                        </li>
                        <li class="submenu-item nav-item">
                            <a href="contents/brandSettings.html">
                                <p>Gerenciar Marca</p>
                            </a>
                        </li>
                        <li class="submenu-item nav-item">
                            <a href="#">
                                <p>Gerenciar Unidade</p>
                            </a>
                        </li>
                    </ul>

                </ul>
            </nav>
            <!-- fim menu sidebar -->

            <!-- footer sidebar -->
            <div class="footer-sidebar">
                <div class="menu-user">

                    <!-- Dados do Usuario -->
                    <div class="user-icon">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="user-account">
                        <div class="userName"><span class="userNameSpan">User Name</span></div>
                        <div class="userEmail"><span class="userEmailSpan">Email.com</span></div>
                    </div>

                    <!-- Log Out -->
                    <div id="exitBtn">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </div>
                </div>
            </div>
            <!-- fim footer sidebar -->
        </div>
        <!-- fim sidebar -->

        <!-- conteudo da dash -->
        <div class="dash-content">

            <!-- header da dash -->
            <div class="dash-header">

                <div class="title">Boas vindas, <span class="userNameSpan">User Name</span>!</div>
                <div class="head-btn">
                    <i class='bx bxs-inbox'></i>
                </div>
            </div>
            <!-- fim header da dash -->

            <!-- corpo da dash -->
            <div class="dash-body" id="visaoGeral">
                <div class="kpi-wrapper">

                    <!-- kpi 1 -->
                    <div class="kpi-card primary">
                        <div class="kpi-header">
                            <div class="kpi-title">
                                <h2>Unidades Registradas</h2>
                            </div>

                            <div class="tooltip">
                                <i class="fa-solid fa-circle-info"></i>
                                <div class="tooltip-box">
                                    <p>Total de 3 unidades registradas em nosso serviço</p>
                                </div>
                            </div>

                        </div>
                        <div class="kpi-body">
                            <div class="kpi-value">
                                <span id="qtdUnidades"> </span>
                            </div>
                        </div>
                    </div>

                    <!-- kpi 2 -->
                    <div class="kpi-card secondary">
                        <div class="kpi-header">
                            <div class="kpi-title">
                                <h2>Avaliações Positivas X Negativas</h2>
                            </div>
                            <div class="tooltip">
                                <i class="fa-solid fa-circle-info"></i>
                                <div class="tooltip-box">
                                    <p>Satisfação média mensal é baseada na média das avaliações positivas dos clientes
                                        em todas unidades ativas.</p>
                                </div>
                            </div>
                        </div>

                        <div class="kpi-body">
                            <div class="kpi-value">
                                <span id="mediaAvaliacao">20%</span>
                            </div>
                        </div>
                    </div>

                    <!-- kpi 3 -->
                    <div class="kpi-card secondary">
                        <div class="kpi-header">
                            <div class="kpi-title">
                                <h2>Filial mais reclamada do mês</h2>
                            </div>

                            <div class="tooltip">
                                <i class="fa-solid fa-circle-info"></i>
                                <div class="tooltip-box">
                                    <p>Esse valor representa uma estimativa mensal a partir da análise de sentimento dos
                                        clientes.</p>
                                </div>
                            </div>
                        </div>

                        <div class="kpi-body">
                            <div class="kpi-value">
                                <p id="unidadeMaisReclamacoes">Unidade 2</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <!-- card 1 -->
                    <div class="chart-card">
                        <div class="card-header">
                            <div class="card-title">
                                <h2>Distribuição de reclamações no ano</h2>
                            </div>

                            <div class="tooltip">
                                <i class="fa-solid fa-triangle-exclamation"></i>
                                <div class="tooltip-box">
                                    <p>Unidade 3: 72,6%</p>
                                </div>
                            </div>

                        </div>
                        <div class="card-body">
                            <div class="chart-box">
                                <canvas id="myChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- card 2 -->
                    <div class="chart-card swiper">
                        <div class="card-header">
                            <div class="card-title">
                                <h2>Análise aprofundada de unidade</h2>
                            </div>
                            <select id="slideSelector" class="selectSlide">
                                <option value="0">Matriz</option>
                                <option value="1">Unidade 2</option>
                                <option value="2">Unidade 3</option>

                            </select>
                            <!-- Pagination -->
                            <div class="swiper-pagination"></div>
                        </div>


                        <div class="swiper-wrapper">
                            <!-- Unidade 1 -->
                            <div class="card-body swiper-slide">
                                <div class="chart-box flex-display">
                                    <!-- wrap 1 -->
                                    <div class="wrap-area">
                                        <!-- descricao da unidade -->

                                        <div class="unit-desc">
                                            <h3 class="name">Unidade Matriz</h3>
                                            <p class="adress">Av. Sapopemba, 20020 - Vila Ester, São Paulo - SP,
                                                08330-245</p>
                                        </div>
                                        <!-- status da unidade -->
                                        <div class="unit-stats">
                                            <span class="review-rating">3.5</span>
                                            <span class="star-rating" data-rating-value="3.5"></span>
                                            <span class="review-number">(679 avaliações)</span>
                                        </div>
                                        <!-- grafico de avaliações -->

                                        <div class="chart-mini-box">
                                            <canvas id="myBarChart1"></canvas>
                                        </div>

                                    </div>
                                    <!-- wrap 2 -->
                                    <div class="wrap-area">
                                        <a href="unidadeMatriz.html" class="linkBtn">acessar</a>
                                    </div>
                                </div>
                            </div>

                            <!-- Unidade 2 -->
                            <div class="card-body swiper-slide">

                                <div class="chart-box flex-display">
                                    <!-- wrap 1 -->
                                    <div class="wrap-area">
                                        <!-- descricao da unidade -->
                                        <div class="unit-desc">
                                            <h3 class="name">Unidade 2</h3>
                                            <p class="adress">Av. das Américas, 5000 - Barra da Tijuca, Rio de Janeiro -
                                                RJ, 22640-102</p>
                                        </div>
                                        <!-- status da unidade -->
                                        <div class="unit-stats">
                                            <span class="review-rating">3.9</span>
                                            <span class="star-rating" data-rating-value="3.9"></span>
                                            <span class="review-number">(999 avaliações)</span>
                                        </div>
                                        <!-- grafico de avaliações -->
                                        <div class="chart-mini-box">
                                            <canvas id="myBarChart2"></canvas>
                                        </div>
                                    </div>
                                    <!-- wrap 2 -->
                                    <div class="wrap-area">
                                        <a href="unidade2.html" class="linkBtn">acessar</a>
                                    </div>
                                </div>
                            </div>

                            <!-- Unidade 3 -->
                            <div class="card-body swiper-slide">
                                <div class="chart-box flex-display">
                                    <!-- wrap 1 -->
                                    <div class="wrap-area">
                                        <!-- descricao da unidade -->
                                        <div class="unit-desc">
                                            <h3 class="name">Unidade 3</h3>
                                            <p class="adress">Av. Afonso Pena, 1000 - Centro, Belo Horizonte - MG,
                                                30130-003</p>
                                        </div>
                                        <!-- status da unidade -->
                                        <div class="unit-stats">
                                            <span class="review-rating">2.2</span>
                                            <span class="star-rating" data-rating-value="2.2"></span>
                                            <span class="review-number">(1920 avaliações)</span>
                                        </div>
                                        <!-- grafico de avaliações -->
                                        <div class="chart-mini-box">
                                            <canvas id="myBarChart3"></canvas>
                                        </div>
                                    </div>
                                    <!-- wrap 2 -->
                                    <div class="wrap-area">
                                        <a href="unidade3.html" class="linkBtn">acessar</a>
                                    </div>
                                    
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
                <!-- fim do corpo da dash -->

            </div>
            <!-- fim conteudo da dash -->

        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

        <script src="../dashboard/static pages/static js/graficoBodyDash.js"></script>
        
        <script src="../js/dashboard.js"></script>
        <!-- JS do Swiper Slides -->
        <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
</body>

</html>

<script>

    // Sidebar Dinâmico - Essa função arruma o sidebar para abrir e fechar
    const barBtn = document.getElementById("toggle-dash-btn");
    const sidebar = document.querySelector(".sidebar");
    const dashContent = document.querySelector(".dash-content");
    const subMenuBtns = document.querySelectorAll(".submenu");


    const toggleSidebar = () => {
        sidebar.classList.toggle("active");
        dashContent.classList.toggle("active");

        // Fecha todos os submenus ao alternar o sidebar
        subMenuBtns.forEach(btn => {
            const subMenuList = btn.nextElementSibling;
            if (subMenuList) {
                subMenuList.classList.remove("active");
            }
        });
    }

    barBtn.addEventListener("click", () => {
        toggleSidebar();
    });


    subMenuBtns.forEach((btn) => {
        btn.addEventListener("click", (event) => {
            event.preventDefault(); // Impede o comportamento padrão do link <a>

            // Encontra a lista submenu correspondente
            const subMenuList = btn.nextElementSibling;

            if (subMenuList) { // Verifica se o submenu existe
                // Fecha outros submenus abertos
                subMenuBtns.forEach(otherBtn => {
                    if (otherBtn !== btn) {
                        const otherSubMenuList = otherBtn.nextElementSibling;
                        if (otherSubMenuList) {
                            otherSubMenuList.classList.remove("active");
                        }
                    }
                });

                // Alterna a visibilidade do submenu clicado
                subMenuList.classList.toggle("active");

                // Ajusta o sidebar se estiver aberto e o submenu for ativado
                if (sidebar.classList.contains("active") && subMenuList.classList.contains("active")) {
                    sidebar.classList.remove("active");
                    dashContent.classList.remove("active");
                }
            }
        });
    });

    // Seleciona todos os elementos que contêm as estrelas
    const divEstrelasList = document.querySelectorAll('.star-rating');

    // Itera sobre cada elemento
    divEstrelasList.forEach(divEstrelas => {
        // Converte o valor de avaliação para um número
        const valorEstrela = Number(divEstrelas.getAttribute('data-rating-value'));

        // Separa a parte inteira e decimal do valor de avaliação
        const valorEstrelaInteiro = Math.trunc(valorEstrela);
        const valorEstrelaDecimal = valorEstrela - valorEstrelaInteiro;


        // Adiciona estrelas inteiras
        for (let i = 0; i < valorEstrelaInteiro; i++) {
            const starIcon = document.createElement('i');
            starIcon.classList.add('fa-solid', 'fa-star', 'fill-star');
            divEstrelas.appendChild(starIcon);
        }

        // Adiciona meia estrela se necessário
        if (valorEstrelaDecimal >= 0.5) {
            const starIcon = document.createElement('i');
            starIcon.classList.add('fa-solid', 'fa-star-half', 'fill-star');
            divEstrelas.appendChild(starIcon);
        }

        // Conta a quantidade de estrelas já adicionadas
        let qntdEstrelaPreenchida = divEstrelas.querySelectorAll('.fill-star').length;

        // Adiciona estrelas vazias para completar 5 estrelas
        for (let i = qntdEstrelaPreenchida; i < 5; i++) {
            const starIcon = document.createElement('i');
            starIcon.classList.add('fa-solid', 'fa-star', 'null-star'); // Estrela vazia
            divEstrelas.appendChild(starIcon);
        }
    });

    function kpiUnidadesGeral() {
    fetch("/kpi/listar", { cache: "no-store" }) 
        .then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    const qtdUnidades = document.getElementById("qtdUnidades");
                    
                   
                    if (resposta && resposta.length > 0) {
                        qtdUnidades.innerHTML = resposta.length; 
                    } else {
                        qtdUnidades.innerHTML = "Nenhuma unidade ativa";
                    }
                });
            } else {
                console.error("Erro ao buscar as unidades");
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados para KPI: ${error.message}`);
        });
}


kpiUnidadesGeral();

function kpiMaisReclamacoes() {
    fetch("/kpi/maisReclamacoes", { cache: "no-store" })
    .then(function (resposta) {
            resposta.json().then((kpi) => {
                console.log("Resultado das reclamações", kpi)
                kpi.forEach((reclamacao) => {
                    unidadeMaisReclamacoes.innerHTML =` <span>${reclamacao.Unidade}</span>`
                });
            });

        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados: ${error.message}`);
        });
}

// Execute a função ao carregar a página
kpiMaisReclamacoes();


function kpiNegativasXPositivas() {
    // Exemplo de chamada para NegativasXPositivas
// Fazendo a requisição à API NegativasXPositivas
fetch('/kpi/NegativasXPositivas')
    .then(response => {
        if (!response.ok) throw new Error("Erro na requisição da API NegativasXPositivas");
        return response.json();
    })
    .then(data => {
        console.log("Resultado NegativasXPositivas:", data);
        // Supondo que você exiba no HTML o valor retornado
        document.getElementById("mediaAvaliacao").textContent = data[0]?.media_avaliacoes_positivas || "N/A";
    })
    .catch(error => {
        console.error("Erro ao buscar NegativasXPositivas:", error);
    });


}

kpiNegativasXPositivas(); 




</script>